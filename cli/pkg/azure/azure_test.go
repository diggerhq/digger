package azure

import (
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestGetAzureReposContext(t *testing.T) {

	context := "{\n    \"id\": \"a5425068-eade-4753-a703-2a7670b94fca\",\n    \"eventType\": \"ms.vss-code.git-pullrequest-comment-event\",\n    \"publisherId\": \"tfs\",\n    \"message\": {\n        \"text\": \"Mohamed Habib has commented on a pull request\",\n        \"html\": \"Mohamed Habib has <a href=\\\"https://dev.azure.com/moehabib9/digger-test/_git/digger-test/pullrequest/1?discussionId=1\\\">commented</a> on a pull request\",\n        \"markdown\": \"Mohamed Habib has [commented](https://dev.azure.com/moehabib9/digger-test/_git/digger-test/pullrequest/1?discussionId=1) on a pull request\"\n    },\n    \"detailedMessage\": {\n        \"text\": \"Mohamed Habib has commented on a pull request\\r\\ndigger plan\\r\\n\",\n        \"html\": \"Mohamed Habib has <a href=\\\"https://dev.azure.com/moehabib9/digger-test/_git/digger-test/pullrequest/1?discussionId=1\\\">commented</a> on a pull request<p>digger plan</p>\",\n        \"markdown\": \"Mohamed Habib has [commented](https://dev.azure.com/moehabib9/digger-test/_git/digger-test/pullrequest/1?discussionId=1) on a pull request\\r\\ndigger plan\\r\\n\"\n    },\n    \"resource\": {\n        \"comment\": {\n            \"id\": 1,\n            \"parentCommentId\": 0,\n            \"author\": {\n                \"displayName\": \"Mohamed Habib\",\n                \"url\": \"https://spsprodweu5.vssps.visualstudio.com/A8e479c0b-ee1b-43c7-9ed8-98f2a7ec6d01/_apis/Identities/d08e23e0-8b42-6ab5-a2b4-5f1dd4d1ed68\",\n                \"_links\": {\n                    \"avatar\": {\n                        \"href\": \"https://dev.azure.com/moehabib9/_apis/GraphProfile/MemberAvatars/msa.ZDA4ZTIzZTAtOGI0Mi03YWI1LWEyYjQtNWYxZGQ0ZDFlZDY4\"\n                    }\n                },\n                \"id\": \"d08e23e0-8b42-6ab5-a2b4-5f1dd4d1ed68\",\n                \"uniqueName\": \"moe.habib9@gmail.com\",\n                \"imageUrl\": \"https://dev.azure.com/moehabib9/_apis/GraphProfile/MemberAvatars/msa.ZDA4ZTIzZTAtOGI0Mi03YWI1LWEyYjQtNWYxZGQ0ZDFlZDY4\",\n                \"descriptor\": \"msa.ZDA4ZTIzZTAtOGI0Mi03YWI1LWEyYjQtNWYxZGQ0ZDFlZDY4\"\n            },\n            \"content\": \"digger plan\",\n            \"publishedDate\": \"2023-05-31T14:43:11.517Z\",\n            \"lastUpdatedDate\": \"2023-05-31T14:43:11.517Z\",\n            \"lastContentUpdatedDate\": \"2023-05-31T14:43:11.517Z\",\n            \"commentType\": \"text\",\n            \"usersLiked\": [],\n            \"_links\": {\n                \"self\": {\n                    \"href\": \"https://dev.azure.com/moehabib9/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/pullRequests/1/threads/1/comments/1\"\n                },\n                \"repository\": {\n                    \"href\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331\"\n                },\n                \"threads\": {\n                    \"href\": \"https://dev.azure.com/moehabib9/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/pullRequests/1/threads/1\"\n                },\n                \"pullRequests\": {\n                    \"href\": \"https://dev.azure.com/moehabib9/_apis/git/pullRequests/1\"\n                }\n            }\n        },\n        \"pullRequest\": {\n            \"repository\": {\n                \"id\": \"7eca30de-5afd-48e0-8c1f-e557c437d331\",\n                \"name\": \"digger-test\",\n                \"url\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331\",\n                \"project\": {\n                    \"id\": \"a2def61f-157f-4382-b12f-184921223688\",\n                    \"name\": \"digger-test\",\n                    \"url\": \"https://dev.azure.com/moehabib9/_apis/projects/a2def61f-157f-4382-b12f-184921223688\",\n                    \"state\": \"wellFormed\",\n                    \"revision\": 37,\n                    \"visibility\": \"private\",\n                    \"lastUpdateTime\": \"2023-05-31T14:04:47.047Z\"\n                },\n                \"size\": 44640,\n                \"remoteUrl\": \"https://moehabib9@dev.azure.com/moehabib9/digger-test/_git/digger-test\",\n                \"sshUrl\": \"git@ssh.dev.azure.com:v3/moehabib9/digger-test/digger-test\",\n                \"webUrl\": \"https://dev.azure.com/moehabib9/digger-test/_git/digger-test\",\n                \"isDisabled\": false,\n                \"isInMaintenance\": false\n            },\n            \"pullRequestId\": 1,\n            \"codeReviewId\": 1,\n            \"status\": \"active\",\n            \"createdBy\": {\n                \"displayName\": \"Mohamed Habib\",\n                \"url\": \"https://spsprodweu5.vssps.visualstudio.com/A8e479c0b-ee1b-43c7-9ed8-98f2a7ec6d01/_apis/Identities/d08e23e0-8b42-6ab5-a2b4-5f1dd4d1ed68\",\n                \"_links\": {\n                    \"avatar\": {\n                        \"href\": \"https://dev.azure.com/moehabib9/_apis/GraphProfile/MemberAvatars/msa.ZDA4ZTIzZTAtOGI0Mi03YWI1LWEyYjQtNWYxZGQ0ZDFlZDY4\"\n                    }\n                },\n                \"id\": \"d08e23e0-8b42-6ab5-a2b4-5f1dd4d1ed68\",\n                \"uniqueName\": \"moe.habib9@gmail.com\",\n                \"imageUrl\": \"https://dev.azure.com/moehabib9/_api/_common/identityImage?id=d08e23e0-8b42-6ab5-a2b4-5f1dd4d1ed68\",\n                \"descriptor\": \"msa.ZDA4ZTIzZTAtOGI0Mi03YWI1LWEyYjQtNWYxZGQ0ZDFlZDY4\"\n            },\n            \"creationDate\": \"2023-05-31T14:41:30.7525172Z\",\n            \"title\": \"Updated main.tf\",\n            \"description\": \"Updated main.tf\",\n            \"sourceRefName\": \"refs/heads/test-1\",\n            \"targetRefName\": \"refs/heads/main\",\n            \"mergeStatus\": \"succeeded\",\n            \"isDraft\": false,\n            \"mergeId\": \"58795d35-ab4e-445b-9c73-859a3eea1bbe\",\n            \"lastMergeSourceCommit\": {\n                \"commitId\": \"881bdbdda340529887c8ad46c06b0342715c4653\",\n                \"url\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/commits/881bdbdda340529887c8ad46c06b0342715c4653\"\n            },\n            \"lastMergeTargetCommit\": {\n                \"commitId\": \"c254effb63be65b0f924b473385c45f4dc4c4e96\",\n                \"url\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/commits/c254effb63be65b0f924b473385c45f4dc4c4e96\"\n            },\n            \"lastMergeCommit\": {\n                \"commitId\": \"dccb8e2c3232118d6023d862472afb4bf146dc39\",\n                \"author\": {\n                    \"name\": \"Mohamed Habib\",\n                    \"email\": \"moe.habib9@gmail.com\",\n                    \"date\": \"2023-05-31T14:41:30Z\"\n                },\n                \"committer\": {\n                    \"name\": \"Mohamed Habib\",\n                    \"email\": \"moe.habib9@gmail.com\",\n                    \"date\": \"2023-05-31T14:41:30Z\"\n                },\n                \"comment\": \"Merge pull request 1 from test-1 into main\",\n                \"url\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/commits/dccb8e2c3232118d6023d862472afb4bf146dc39\"\n            },\n            \"reviewers\": [],\n            \"url\": \"https://dev.azure.com/moehabib9/a2def61f-157f-4382-b12f-184921223688/_apis/git/repositories/7eca30de-5afd-48e0-8c1f-e557c437d331/pullRequests/1\",\n            \"supportsIterations\": true,\n            \"artifactId\": \"vstfs:///Git/PullRequestId/a2def61f-157f-4382-b12f-184921223688%2f7eca30de-5afd-48e0-8c1f-e557c437d331%2f1\"\n        }\n    },\n    \"resourceVersion\": \"2.0\",\n    \"resourceContainers\": {\n        \"collection\": {\n            \"id\": \"f658bb7d-1dad-4fd9-b188-2fe9e914b810\",\n            \"baseUrl\": \"https://dev.azure.com/moehabib9/\"\n        },\n        \"account\": {\n            \"id\": \"8e479c0b-ee1b-43c7-9ed8-98f2a7ec6d01\",\n            \"baseUrl\": \"https://dev.azure.com/moehabib9/\"\n        },\n        \"project\": {\n            \"id\": \"a2def61f-157f-4382-b12f-184921223688\",\n            \"baseUrl\": \"https://dev.azure.com/moehabib9/\"\n        }\n    },\n    \"createdDate\": \"2023-05-31T14:43:18.079Z\"\n}"

	az, _ := GetAzureReposContext(context)
	assert.Equal(t, "digger plan", az.Event.(AzureCommentEvent).Resource.Comment.Content)
}
