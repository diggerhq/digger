name: Test Database Migrations

on:
  pull_request:
    paths:
      - 'taco/internal/query/types/**'
      - 'taco/internal/query/migration/**'
      - 'taco/internal/queryfactory/**'
      - 'taco/atlas.hcl'
      - 'taco/internal/atlas_loader.go'
      - '.github/workflows/test-migrations.yml'
  push:
    branches:
      - main
    paths:
      - 'taco/internal/query/types/**'
      - 'taco/internal/query/migration/**'
      - 'taco/internal/queryfactory/**'
      - 'taco/atlas.hcl'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  test-postgres:
    name: Test PostgreSQL Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16.1
        env:
          POSTGRES_DB: opentaco_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: |
            taco/go.sum
            go.work.sum

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh
          atlas version

      - name: Build statesman binary
        working-directory: taco
        run: |
          go build -o statesman ./cmd/statesman

      - name: Test migrations with binary
        working-directory: taco
        env:
          OPENTACO_BACKEND: postgres
          OPENTACO_POSTGRES_HOST: localhost
          OPENTACO_POSTGRES_PORT: 5432
          OPENTACO_POSTGRES_USER: postgres
          OPENTACO_POSTGRES_PASSWORD: postgres
          OPENTACO_POSTGRES_DATABASE: opentaco_test
          OPENTACO_POSTGRES_SSLMODE: disable
          OPENTACO_AUTH_DISABLE: true
          OPENTACO_JWT_SECRET: test-secret-key-for-ci
        run: |
          # Check Atlas is available
          echo "Checking for Atlas CLI..."
          which atlas || echo "Atlas not in PATH!"
          atlas version || echo "Atlas command failed!"
          
          # Run binary and capture output
          echo "Starting statesman binary..."
          timeout 30s ./statesman --port 8080 --auth-disable --storage memory > statesman.log 2>&1 || true
          
          echo "Binary output:"
          cat statesman.log
          
          # Give it time to apply migrations
          sleep 5

      - name: Verify migrations applied
        working-directory: taco
        env:
          PGPASSWORD: postgres
        run: |
          # Check if migrations applied successfully from binary output
          if grep -i "migrations applied successfully\|migrations already up to date" statesman.log; then
            echo "✅ Migrations applied successfully"
          else
            echo "❌ Migration success message not found in binary output"
            cat statesman.log
            exit 1
          fi
          
          # Verify golang-migrate tracking table exists
          echo "Checking if schema_migrations table exists..."
          psql -h localhost -U postgres -d opentaco_test -c "\dt" | grep schema_migrations
          
          echo "Checking applied migrations..."
          psql -h localhost -U postgres -d opentaco_test -c "SELECT version, dirty FROM schema_migrations;"
          
          echo "Checking if key tables exist..."
          psql -h localhost -U postgres -d opentaco_test -c "\dt" | grep -E "units|organizations|users|rules"

  test-mysql:
    name: Test MySQL Migrations
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: opentaco_test
          MYSQL_USER: mysql
          MYSQL_PASSWORD: mysql
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: |
            taco/go.sum
            go.work.sum

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh
          atlas version

      - name: Build statesman binary
        working-directory: taco
        run: |
          go build -o statesman ./cmd/statesman

      - name: Test migrations with binary
        working-directory: taco
        env:
          OPENTACO_BACKEND: mysql
          OPENTACO_MYSQL_HOST: localhost
          OPENTACO_MYSQL_PORT: 3306
          OPENTACO_MYSQL_USER: mysql
          OPENTACO_MYSQL_PASSWORD: mysql
          OPENTACO_MYSQL_DATABASE: opentaco_test
          OPENTACO_AUTH_DISABLE: true
          OPENTACO_JWT_SECRET: test-secret-key-for-ci
        run: |
          # Check Atlas is available
          echo "Checking for Atlas CLI..."
          which atlas || echo "Atlas not in PATH!"
          atlas version || echo "Atlas command failed!"
          
          # Run binary and capture output
          echo "Starting statesman binary..."
          timeout 30s ./statesman --port 8080 --auth-disable --storage memory > statesman.log 2>&1 || true
          
          echo "Binary output:"
          cat statesman.log
          
          # Give it time to apply migrations
          sleep 5

      - name: Verify migrations applied
        working-directory: taco
        run: |
          # Check if migrations applied successfully from binary output
          if grep -i "migrations applied successfully\|migrations already up to date" statesman.log; then
            echo "✅ Migrations applied successfully"
          else
            echo "❌ Migration success message not found in binary output"
            cat statesman.log
            exit 1
          fi
          
          # Verify golang-migrate tracking table exists
          echo "Checking if schema_migrations table exists..."
          mysql -h 127.0.0.1 -u mysql -pmysql opentaco_test -e "SHOW TABLES;" | grep schema_migrations
          
          echo "Checking applied migrations..."
          mysql -h 127.0.0.1 -u mysql -pmysql opentaco_test -e "SELECT version, dirty FROM schema_migrations;"
          
          echo "Checking if key tables exist..."
          mysql -h 127.0.0.1 -u mysql -pmysql opentaco_test -e "SHOW TABLES;" | grep -E "units|organizations|users|rules"

  test-sqlite:
    name: Test SQLite Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: |
            taco/go.sum
            go.work.sum

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh
          atlas version

      - name: Build statesman binary
        working-directory: taco
        run: |
          go build -o statesman ./cmd/statesman

      - name: Test migrations with binary
        working-directory: taco
        env:
          OPENTACO_BACKEND: sqlite
          OPENTACO_SQLITE_PATH: ./test.db
          OPENTACO_AUTH_DISABLE: true
          OPENTACO_JWT_SECRET: test-secret-key-for-ci
        run: |
          # Run binary and capture output
          echo "Starting statesman binary..."
          timeout 30s ./statesman --port 8080 --auth-disable --storage memory > statesman.log 2>&1 || true
          
          echo "Binary output:"
          cat statesman.log
          
          # Give it time to apply migrations
          sleep 5

      - name: Verify migrations applied
        working-directory: taco
        run: |
          # Check if migrations applied successfully from binary output
          if grep -i "migrations applied successfully\|migrations already up to date" statesman.log; then
            echo "✅ Migrations applied successfully"
          else
            echo "❌ Migration success message not found in binary output"
            cat statesman.log
            exit 1
          fi
          
          # Verify golang-migrate tracking table exists
          echo "Checking if schema_migrations table exists..."
          sqlite3 test.db ".tables" | grep schema_migrations
          
          echo "Checking applied migrations..."
          sqlite3 test.db "SELECT version, dirty FROM schema_migrations;"
          
          echo "Checking if key tables exist..."
          sqlite3 test.db ".tables" | grep -E "units|organizations|users|rules"

  # Summary job that requires all database tests to pass
  all-migrations-passed:
    name: All Migrations Passed
    runs-on: ubuntu-latest
    needs: [test-postgres, test-mysql, test-sqlite]
    steps:
      - name: All tests passed
        run: echo "✅ All database migrations tested successfully!"

